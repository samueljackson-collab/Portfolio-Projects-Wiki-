name: Auto-Update Wiki

on:
  # Run on schedule - check for changes daily
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC daily

  # Run when manually triggered
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Specific repo to process (leave empty for all)'
        required: false
        default: ''
      skip_review:
        description: 'Skip Claude Opus review step'
        required: false
        type: boolean
        default: false
      scan_only:
        description: 'Only scan, do not generate content'
        required: false
        type: boolean
        default: false

  # Run when new repos are created (via push to this repo's config)
  push:
    paths:
      - 'wiki-generator/config.yaml'

permissions:
  contents: write
  pull-requests: write

jobs:
  scan-and-generate:
    name: Scan Repos & Generate Wiki Entries
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r wiki-generator/requirements.txt

      - name: Run Wiki Generator Pipeline
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd wiki-generator
          ARGS=""
          if [ "${{ inputs.scan_only }}" = "true" ]; then
            ARGS="$ARGS --scan-only"
          fi
          if [ "${{ inputs.skip_review }}" = "true" ]; then
            ARGS="$ARGS --skip-review"
          fi
          if [ -n "${{ inputs.target_repo }}" ]; then
            ARGS="$ARGS --repo '${{ inputs.target_repo }}'"
          fi
          python pipeline.py $ARGS --verbose

      - name: Upload pipeline results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wiki-generator-results
          path: |
            wiki-generator/.output/
            wiki-generator/.drafts/
            wiki-generator/.reviewed/
          retention-days: 30

      - name: Check for generated entries
        id: check_output
        run: |
          if [ -d "wiki-generator/.output" ] && [ "$(ls -A wiki-generator/.output/*.json 2>/dev/null | head -1)" ]; then
            echo "has_entries=true" >> $GITHUB_OUTPUT
            echo "Found generated wiki entries"
          else
            echo "has_entries=false" >> $GITHUB_OUTPUT
            echo "No new entries generated"
          fi

      - name: Create Pull Request with updates
        if: steps.check_output.outputs.has_entries == 'true' && inputs.scan_only != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(wiki): auto-generate wiki entries for new/updated repos"
          title: "Wiki Update: New entries from auto-scanner"
          body: |
            ## Automated Wiki Update

            The wiki generator pipeline detected changes and generated new entries.

            ### What was generated
            See the `wiki-generator/.output/` directory for the generated entries
            with merge instructions.

            ### Review checklist
            - [ ] Review generated entries for accuracy
            - [ ] Verify code examples are correct
            - [ ] Check that threat models are appropriate
            - [ ] Merge entries into `constants.ts`

            ---
            *Generated by the Wiki Auto-Update pipeline*
          branch: wiki-auto-update
          delete-branch: true
          labels: |
            wiki
            automated
